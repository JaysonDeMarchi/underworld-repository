#!/bin/bash

set -e

PROJECT_ROOT="$(dirname $0)/.."
# We need to export the STAGE so we have access to it when naming our pm2 processes
# see: ecosystem.config.js
export STAGE="$1"
RELEASE_TARGET="$2"

if [ -z "$STAGE" ]; then
	echo "Missing stage parameter (e.g. staging, production)"
	echo "- e.g. deploy <stage> <release_target>"
	exit
fi

if [ -z "$RELEASE_TARGET" ]; then
	echo "Missing release target parameter (e.g. release/vX.Y.Z, develop)"
	echo "- e.g. deploy <stage> <release_target>"
	exit
fi

pushd "$PROJECT_ROOT" > /dev/null

git fetch --all

# On a new environment there will be no pm2 installed.
if [ -d "./node_modules/pm2" ]; then
	npm run stop
fi

# We want to make sure there is a local main for nx to build properly.
if [ -z "$(git show-ref refs/heads/main)" ]; then
	git branch --track main
fi

git checkout "$RELEASE_TARGET"

echo "��Install"
npm install
echo "��Build"
npm run build
echo "��Start"
npm run start

popd > /dev/null
